<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Class: Rex::Exploitation::Seh
  
    &mdash; Documentation by YARD 0.9.5
  
</title>

  <link rel="stylesheet" href="../../css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="../../css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  pathId = "Rex::Exploitation::Seh";
  relpath = '../../';
</script>


  <script type="text/javascript" charset="utf-8" src="../../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../../class_list.html"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../../_index.html">Index (S)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../Rex.html" title="Rex (module)">Rex</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../Exploitation.html" title="Rex::Exploitation (module)">Exploitation</a></span></span>
     &raquo; 
    <span class="title">Seh</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <iframe id="search_frame" src="../../class_list.html"></iframe>

      <div id="content"><h1>Class: Rex::Exploitation::Seh
  
  
  
</h1>
<div class="box_info">
  
  <dl>
    <dt>Inherits:</dt>
    <dd>
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">Rex::Exploitation::Seh</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
    </dd>
  </dl>
  

  
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>lib/rex/exploitation/seh.rb</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>This class provides methods for generating SEH registration records in a
dynamic and flexible fashion.  The records can be generated with the short
jump at a random offset into the next pointer and with random padding in
between the handler and the attacker&#39;s payload.</p>


  </div>
</div>
<div class="tags">
  

</div>



  <h2>Instance Attribute Summary <small><a href="#" class="summary_toggle">collapse</a></small></h2>
  <ul class="summary">
    
      <li class="protected ">
  <span class="summary_signature">
    
      <a href="#badchars-instance_method" title="#badchars (instance method)">#<strong>badchars</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
    
    
  
  <span class="note title protected">protected</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>:nodoc:.</p>
</div></span>
  
</li>

    
      <li class="protected ">
  <span class="summary_signature">
    
      <a href="#nop-instance_method" title="#nop (instance method)">#<strong>nop</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
    
    
  
  <span class="note title protected">protected</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>:nodoc:.</p>
</div></span>
  
</li>

    
      <li class="protected ">
  <span class="summary_signature">
    
      <a href="#space-instance_method" title="#space (instance method)">#<strong>space</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
    
    
  
  <span class="note title protected">protected</span>
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>:nodoc:.</p>
</div></span>
  
</li>

    
  </ul>




  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#generate_dynamic_seh_record-instance_method" title="#generate_dynamic_seh_record (instance method)">#<strong>generate_dynamic_seh_record</strong>(handler)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Generates a fake SEH registration record with the supplied handler address
for the handler, and a nop generator to use when generating padding inside
the next pointer.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#generate_seh_record-instance_method" title="#generate_seh_record (instance method)">#<strong>generate_seh_record</strong>(handler, dynamic = false)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Generates an SEH record.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#generate_static_seh_record-instance_method" title="#generate_static_seh_record (instance method)">#<strong>generate_static_seh_record</strong>(handler)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Generates a static SEH registration record with a specific handler and next
pointer.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">#<strong>initialize</strong>(badchars = nil, space = nil, nop = nil)  &#x21d2; Seh </a>
    

    
  </span>
  
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Creates a new instance of the class and initializes it with the supplied
bad character list.</p>
</div></span>
  
</li>

      
    </ul>
  

<div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <h3 class="signature first" id="initialize-instance_method">
  
    #<strong>initialize</strong>(badchars = nil, space = nil, nop = nil)  &#x21d2; <tt><span class='object_link'><a href="" title="Rex::Exploitation::Seh (class)">Seh</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Creates a new instance of the class and initializes it with the supplied
bad character list.  The space argument denotes how much room is available
for random padding and the NOP argument can be used to generate a random
NOP sled that is better than 0x90.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


24
25
26
27
28</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rex/exploitation/seh.rb', line 24</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_badchars'>badchars</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_space'>space</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_nop'>nop</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_badchars'>badchars</span> <span class='op'>=</span> <span class='id identifier rubyid_badchars'>badchars</span> <span class='op'>||</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_space'>space</span>    <span class='op'>=</span> <span class='lparen'>(</span><span class='id identifier rubyid_space'>space</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_space'>space</span> <span class='op'>&gt;</span> <span class='int'>121</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='int'>121</span> <span class='op'>:</span> <span class='id identifier rubyid_space'>space</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_nop'>nop</span>      <span class='op'>=</span> <span class='id identifier rubyid_nop'>nop</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
  
</div>

  <div id="instance_attr_details" class="attr_details">
    <h2>Instance Attribute Details</h2>
    
      
      <span id="badchars=-instance_method"></span>
      <div class="method_details first">
  <h3 class="signature first" id="badchars-instance_method">
  
    #<strong>badchars</strong>  &#x21d2; <tt>Object</tt>  <span class="extras">(protected)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>:nodoc:</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


88
89
90</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rex/exploitation/seh.rb', line 88</span>

<span class='kw'>def</span> <span class='id identifier rubyid_badchars'>badchars</span>
  <span class='ivar'>@badchars</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="nop=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="nop-instance_method">
  
    #<strong>nop</strong>  &#x21d2; <tt>Object</tt>  <span class="extras">(protected)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>:nodoc:</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


88
89
90</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rex/exploitation/seh.rb', line 88</span>

<span class='kw'>def</span> <span class='id identifier rubyid_nop'>nop</span>
  <span class='ivar'>@nop</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      
      <span id="space=-instance_method"></span>
      <div class="method_details ">
  <h3 class="signature " id="space-instance_method">
  
    #<strong>space</strong>  &#x21d2; <tt>Object</tt>  <span class="extras">(protected)</span>
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>:nodoc:</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


88
89
90</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rex/exploitation/seh.rb', line 88</span>

<span class='kw'>def</span> <span class='id identifier rubyid_space'>space</span>
  <span class='ivar'>@space</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="generate_dynamic_seh_record-instance_method">
  
    #<strong>generate_dynamic_seh_record</strong>(handler)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Generates a fake SEH registration record with the supplied handler address
for the handler, and a nop generator to use when generating padding inside
the next pointer.  The NOP generator must implement the
&#39;generate_sled&#39; method that takes a length and a list of bad
characters.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rex/exploitation/seh.rb', line 48</span>

<span class='kw'>def</span> <span class='id identifier rubyid_generate_dynamic_seh_record'>generate_dynamic_seh_record</span><span class='lparen'>(</span><span class='id identifier rubyid_handler'>handler</span><span class='rparen'>)</span>

  <span class='comment'># Generate the padding up to the size specified or 121 characters
</span>  <span class='comment'># maximum to account for the maximum range of a short jump plus the
</span>  <span class='comment'># record size.
</span>  <span class='id identifier rubyid_pad'>pad</span>    <span class='op'>=</span> <span class='id identifier rubyid_rand'>rand</span><span class='lparen'>(</span><span class='id identifier rubyid_space'>space</span> <span class='op'>||</span> <span class='int'>121</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_rsize'>rsize</span>  <span class='op'>=</span> <span class='id identifier rubyid_pad'>pad</span> <span class='op'>+</span> <span class='int'>8</span>

  <span class='comment'># Calculate the random index into the next ptr to store the short jump
</span>  <span class='comment'># instruction
</span>  <span class='id identifier rubyid_jmpidx'>jmpidx</span> <span class='op'>=</span> <span class='id identifier rubyid_rand'>rand</span><span class='lparen'>(</span><span class='int'>3</span><span class='rparen'>)</span>

  <span class='comment'># Build the prefixed sled for the bytes that come before the short jump
</span>  <span class='comment'># instruction
</span>  <span class='id identifier rubyid_sled'>sled</span> <span class='op'>=</span> <span class='lparen'>(</span><span class='id identifier rubyid_nop'>nop</span><span class='rparen'>)</span> <span class='op'>?</span> <span class='id identifier rubyid_nop'>nop</span><span class='period'>.</span><span class='id identifier rubyid_generate_sled'>generate_sled</span><span class='lparen'>(</span><span class='id identifier rubyid_jmpidx'>jmpidx</span><span class='comma'>,</span> <span class='id identifier rubyid_badchars'>badchars</span><span class='rparen'>)</span> <span class='op'>:</span> <span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\x90</span><span class='tstring_end'>&quot;</span></span> <span class='op'>*</span> <span class='id identifier rubyid_jmpidx'>jmpidx</span><span class='rparen'>)</span>

  <span class='comment'># Seed the record and any space after the record with random text
</span>  <span class='id identifier rubyid_record'>record</span> <span class='op'>=</span> <span class='const'>Rex</span><span class='op'>::</span><span class='const'>Text</span><span class='period'>.</span><span class='id identifier rubyid_rand_text'>rand_text</span><span class='lparen'>(</span><span class='id identifier rubyid_rsize'>rsize</span><span class='comma'>,</span> <span class='id identifier rubyid_badchars'>badchars</span><span class='rparen'>)</span>

  <span class='comment'># Build the next pointer and short jump instruction
</span>  <span class='id identifier rubyid_record'>record</span><span class='lbracket'>[</span><span class='id identifier rubyid_jmpidx'>jmpidx</span><span class='comma'>,</span> <span class='int'>2</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='const'>Rex</span><span class='op'>::</span><span class='const'>Arch</span><span class='op'>::</span><span class='const'>X86</span><span class='period'>.</span><span class='id identifier rubyid_jmp_short'>jmp_short</span><span class='lparen'>(</span><span class='lparen'>(</span><span class='id identifier rubyid_rsize'>rsize</span> <span class='op'>-</span> <span class='id identifier rubyid_jmpidx'>jmpidx</span><span class='rparen'>)</span> <span class='op'>-</span> <span class='int'>2</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_record'>record</span><span class='lbracket'>[</span><span class='int'>0</span><span class='comma'>,</span> <span class='id identifier rubyid_jmpidx'>jmpidx</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_sled'>sled</span>

  <span class='comment'># Set the handler in the registration record
</span>  <span class='id identifier rubyid_record'>record</span><span class='lbracket'>[</span><span class='int'>4</span><span class='comma'>,</span> <span class='int'>4</span><span class='rbracket'>]</span>      <span class='op'>=</span> <span class='lbracket'>[</span> <span class='id identifier rubyid_handler'>handler</span> <span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>V</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>

  <span class='comment'># Return the generated record to the caller
</span>  <span class='id identifier rubyid_record'>record</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="generate_seh_record-instance_method">
  
    #<strong>generate_seh_record</strong>(handler, dynamic = false)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Generates an SEH record</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


33
34
35
36
37
38
39</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rex/exploitation/seh.rb', line 33</span>

<span class='kw'>def</span> <span class='id identifier rubyid_generate_seh_record'>generate_seh_record</span><span class='lparen'>(</span><span class='id identifier rubyid_handler'>handler</span><span class='comma'>,</span> <span class='id identifier rubyid_dynamic'>dynamic</span><span class='op'>=</span><span class='kw'>false</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_dynamic'>dynamic</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_generate_dynamic_seh_record'>generate_dynamic_seh_record</span><span class='lparen'>(</span><span class='id identifier rubyid_handler'>handler</span><span class='rparen'>)</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_generate_static_seh_record'>generate_static_seh_record</span><span class='lparen'>(</span><span class='id identifier rubyid_handler'>handler</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="generate_static_seh_record-instance_method">
  
    #<strong>generate_static_seh_record</strong>(handler)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Generates a static SEH registration record with a specific handler and next
pointer.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


82
83
84</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/rex/exploitation/seh.rb', line 82</span>

<span class='kw'>def</span> <span class='id identifier rubyid_generate_static_seh_record'>generate_static_seh_record</span><span class='lparen'>(</span><span class='id identifier rubyid_handler'>handler</span><span class='rparen'>)</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\xeb\x06</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='const'>Rex</span><span class='op'>::</span><span class='const'>Text</span><span class='period'>.</span><span class='id identifier rubyid_rand_text'>rand_text</span><span class='lparen'>(</span><span class='int'>2</span><span class='comma'>,</span> <span class='id identifier rubyid_badchars'>badchars</span><span class='rparen'>)</span> <span class='op'>+</span> <span class='lbracket'>[</span> <span class='id identifier rubyid_handler'>handler</span> <span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_pack'>pack</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>V</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Tue Aug 23 22:35:01 2016 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.5 (ruby-2.3.1).
</div>

    </div>
  </body>
</html>